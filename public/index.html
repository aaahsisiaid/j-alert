<!--
ファイル集（全文）
1) index.html           - PWA 本体 (HTML + CSS + JS)
2) firebase-messaging-sw.js - Service Worker (FCMバックグラウンド受信)
3) manifest.json        - PWA マニフェスト
4) .github/workflows/schedule.yml - GitHub Actions cron (定期実行)
5) send_notifications.js - GitHub Actions で動かす Node スクリプト（Firestoreチェック→FCM送信）

使い方：
- Firebase プロジェクトを作成し、Web アプリの firebaseConfig を取得して index.html の該当箇所に貼る。
- GitHub にこのリポジトリを置き、Secrets に FIREBASE_SERVICE_ACCOUNT(JSONをbase64化したもの) を入れる。
- Firebase Hosting または GitHub Pages にデプロイ（HTTPS 必須）。iPhone の Safari で開いて「ホーム画面に追加」。

※ 重要: 下の "__FIREBASE_CONFIG__" や GitHub Secrets は実際の値に置き換えてください。
-->

<!-- =========================
     1) index.html
     ========================= -->

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>J-Alert PWA — 訓練通知</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0ea5a4">
  <style>
    /* シンプルでちょっとカッコいいスタイル */
    :root{--bg:#0f172a;--card:#0b1220;--accent:#06b6d4;--glass:rgba(255,255,255,0.04)}
    html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', 'メイリオ';background:linear-gradient(180deg,#071126 0%,#07162a 100%);color:#e6eef6}
    .wrap{max-width:820px;margin:36px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:700;color:#051023}
    h1{margin:0;font-size:1.2rem}
    p.lead{opacity:0.9;margin-top:6px}

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:18px;margin-top:18px;box-shadow:0 6px 24px rgba(2,6,23,0.6)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{display:block;font-size:0.85rem;margin-bottom:6px;color:#cfe9f2}
    input,select,button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px 12px;border-radius:10px;color:inherit}
    .muted{opacity:0.7;font-size:0.85rem;margin-top:6px}
    .btn{background:linear-gradient(90deg,var(--accent),#7c3aed);border:0;padding:10px 14px;color:#051023;font-weight:700;cursor:pointer}
    .small{font-size:0.85rem}

    .list{margin-top:12px}
    .list-item{display:flex;justify-content:space-between;padding:12px;border-radius:10px;background:var(--glass);margin-bottom:8px}
    .date{opacity:0.9}
    footer{margin-top:26px;opacity:0.7;font-size:0.85rem}

    @media (max-width:560px){.row{flex-direction:column}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">JA</div>
      <div>
        <h1>J-Alert 訓練通知PWA</h1>
        <p class="lead">iPhoneのホーム画面に追加しておくと、ページを開いていなくても通知が届きます。</p>
      </div>
    </header>

    <section class="card">
      <div class="row">
        <div style="flex:1;min-width:220px">
          <label>イベント日（例: 2025-12-10）</label>
          <input id="eventDate" type="date" />
        </div>
        <div style="width:140px">
          <label>通知時刻（09:00）</label>
          <input id="eventTime" type="time" />
        </div>
        <div style="width:160px">
          <label>何日前に通知？</label>
          <select id="daysBefore">
            <option value="0">当日</option>
            <option value="1">1日前</option>
            <option value="2" selected>2日前</option>
            <option value="3">3日前</option>
            <option value="7">7日前</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>通知メッセージ（省略可）</label>
        <input id="message" placeholder="例: xx/xxにJアラートの訓練があります。" />
        <div class="muted">未入力の場合は自動で「{日付}にJアラートの訓練があります。」になります。</div>
      </div>

      <div style="margin-top:14px;display:flex;gap:10px">
        <button id="save" class="btn">スケジュール保存</button>
        <button id="notifyNow" class="btn" style="background:#34d399">テスト通知を送る</button>
      </div>

      <div class="muted" style="margin-top:10px">※ iPhone では Safari でこのページを開き「ホーム画面に追加」してください。</div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 10px 0">次の予定</h3>
      <div id="next" class="muted">読み込み中...</div>

      <div class="list" id="list"></div>
    </section>

    <footer>無料構成: Firebase + GitHub Actions を利用。問題あれば教えてください。さあホーム画面に追加してテストしよう！</footer>
  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-messaging-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
 <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyCeHtJQZfQBTv4TfZ7pF_qFFTk0Y81koq8",
    authDomain: "j-alert-1bb3c.firebaseapp.com",
    projectId: "j-alert-1bb3c",
    storageBucket: "j-alert-1bb3c.firebasestorage.app",
    messagingSenderId: "591499092612",
    appId: "1:591499092612:web:effb0f2e115b0d1f5c58d1",
    measurementId: "G-ZC1PWP3KLN"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>

  firebase.initializeApp(firebaseConfig);
  const messaging = firebase.messaging();
  const db = firebase.firestore();

  // 登録済みトークンを保存するドキュメントパス
  const TOKENS_COLLECTION = 'device_tokens';
  const SCHEDULE_COLLECTION = 'schedules';

  async function requestPermissionAndGetToken() {
    try {
      const permission = await Notification.requestPermission();
      if (permission !== 'granted') {
        console.warn('通知許可が得られませんでした');
        return null;
      }
      const currentToken = await messaging.getToken({ vapidKey: null });
      return currentToken;
    } catch (e) {
      console.error('トークン取得エラー', e);
      return null;
    }
  }

  async function saveToken(token) {
    if (!token) return;
    const docRef = db.collection(TOKENS_COLLECTION).doc(token);
    await docRef.set({ token, createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
  }

  // UI handlers
  document.getElementById('save').addEventListener('click', async () => {
    const date = document.getElementById('eventDate').value;
    const time = document.getElementById('eventTime').value;
    const days = Number(document.getElementById('daysBefore').value);
    const message = document.getElementById('message').value.trim();
    if (!date || !time) { alert('日付と時刻を指定してください'); return; }

    // イベント日時をUTCで保存するため、Dateを作る
    const localDateTime = new Date(`${date}T${time}:00`);
    // 対象日時から days 日引いた瞬間のローカル時刻を計算
    const notifyDate = new Date(localDateTime.getTime() - days*24*60*60*1000);

    // Firestoreに保存
    const doc = {
      eventDate: firebase.firestore.Timestamp.fromDate(localDateTime),
      notifyAt: firebase.firestore.Timestamp.fromDate(notifyDate),
      daysBefore: days,
      text: message || `${date}にJアラートの訓練があります。`,
      sent: false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    await db.collection(SCHEDULE_COLLECTION).add(doc);
    alert('スケジュールを保存しました');
    loadList();
  });

  document.getElementById('notifyNow').addEventListener('click', async () => {
    // サーバー経由で送る代わりにテスト通知を直接送る（クライアント -> Cloud Functions等が無ければ利用不可）
    // ここでは Firestore に test フラグ付きのドキュメントを追加して GH Actions から pickup できるようにする
    const date = new Date();
    const doc = {
      eventDate: firebase.firestore.Timestamp.fromDate(date),
      notifyAt: firebase.firestore.Timestamp.fromDate(date),
      daysBefore: 0,
      text: `テスト: ${date.toLocaleString()} に Jアラート訓練があります。`,
      sent: false,
      test: true,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    await db.collection(SCHEDULE_COLLECTION).add(doc);
    alert('テスト用ドキュメントを作成しました（数分で通知が届きます）');
  });

  async function loadList() {
    const listEl = document.getElementById('list');
    listEl.innerHTML = '';
    const now = firebase.firestore.Timestamp.now();
    const snap = await db.collection(SCHEDULE_COLLECTION).where('notifyAt', '>=', now).orderBy('notifyAt','asc').limit(10).get();
    if (snap.empty) {
      document.getElementById('next').innerText = '予定はありません';
      return;
    }
    const first = snap.docs[0].data();
    document.getElementById('next').innerText = `${first.notifyAt.toDate().toLocaleString()} - ${first.text}`;

    snap.forEach(doc => {
      const d = doc.data();
      const el = document.createElement('div');
      el.className = 'list-item';
      el.innerHTML = `<div><div class="date">${d.notifyAt.toDate().toLocaleString()}</div><div class="small">${d.text}</div></div><div><button data-id="${doc.id}" class="btn small">削除</button></div>`;
      listEl.appendChild(el);
    });

    // 削除ボタン
    listEl.querySelectorAll('button').forEach(btn => btn.addEventListener('click', async (e) => {
      const id = e.target.dataset.id;
      await db.collection(SCHEDULE_COLLECTION).doc(id).delete();
      loadList();
    }));
  }

  // 初期化
  (async ()=>{
    // Service Worker 登録
    if ('serviceWorker' in navigator) {
      try {
        await navigator.serviceWorker.register('/firebase-messaging-sw.js');
        console.log('Service Worker registered');
      } catch(e) { console.error('SW登録失敗', e); }
    }

    // トークン取得・保存
    const token = await requestPermissionAndGetToken();
    if (token) {
      console.log('FCM token', token);
      await saveToken(token);
    }

    // Firestore からリスト表示
    loadList();

    // バックグラウンドメッセージ受信時の表示（ページ開いているとき）
    messaging.onMessage(payload => {
      console.log('Message received. ', payload);
      const title = payload.notification?.title || 'J-Alert';
      const body = payload.notification?.body || '';
      if (Notification.permission === 'granted') {
        new Notification(title, { body });
      }
    });
  })();

  </script>
</body>
</html>

